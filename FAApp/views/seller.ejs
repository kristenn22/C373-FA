<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Seller Portal - Manage Orders</title>
	<style>
		* { box-sizing: border-box; }
		body {
			margin: 0;
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
			background: #f6f7fb;
			color: #111;
			padding: 0;
		}
		
		.header {
			background: white;
			padding: 20px 40px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			box-shadow: 0 1px 3px rgba(0,0,0,0.1);
		}

		.logo {
			font-size: 28px;
			font-weight: 700;
			color: #000;
			text-decoration: none;
		}

		.nav-links {
			display: flex;
			gap: 24px;
			align-items: center;
		}

		.nav-link {
			color: #666;
			text-decoration: none;
			font-size: 14px;
			transition: color 0.3s;
			cursor: pointer;
		}

		.nav-link:hover {
			color: #000;
		}

		.nav-link.active {
			color: #000;
			font-weight: 600;
			border-bottom: 2px solid #000;
			padding-bottom: 5px;
		}
		
		.shell {
			max-width: 1200px;
			margin: 0 auto;
			background: #fff;
			border-radius: 12px;
			padding: 28px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.08);
			margin: 40px auto;
		}
		h1 { margin: 0 0 12px; font-size: 26px; }
		p.lead { margin: 0 0 20px; color: #444; }
		.card {
			border: 1px solid #e5e7eb;
			border-radius: 10px;
			padding: 16px;
			margin-bottom: 16px;
			background: #fafafa;
		}
		.row { display: flex; gap: 12px; flex-wrap: wrap; }
		.row > div { flex: 1 1 260px; }
		label { display: block; font-weight: 600; margin-bottom: 6px; }
		input {
			width: 100%;
			padding: 10px 12px;
			border: 1px solid #d1d5db;
			border-radius: 8px;
			font-size: 14px;
		}
		button {
			padding: 12px 16px;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			font-weight: 600;
		}
		.primary { background: #111; color: #fff; }
		.primary:hover { background: #222; }
		.ghost { background: #f3f4f6; color: #111; }
		.ghost:hover { background: #e5e7eb; }
		.actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
		.status-box { padding: 10px 12px; border-radius: 8px; background: #eef2ff; color: #3730a3; margin-bottom: 12px; }
		.status-message { padding: 12px; border-radius: 8px; margin-top: 10px; }
		.status-success { background: #ecfdf3; color: #166534; }
		.status-error { background: #fef2f2; color: #991b1b; }
		.status-info { background: #eff6ff; color: #1d4ed8; }
		.mono { font-family: "SFMono-Regular", Consolas, "Liberation Mono", monospace; }
		
		table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 20px;
		}
		th, td {
			padding: 12px;
			text-align: left;
			border-bottom: 1px solid #e5e7eb;
		}
		th {
			background: #f3f4f6;
			font-weight: 600;
		}
		tr:hover {
			background: #fafafa;
		}
		.order-row {
			cursor: pointer;
			transition: background 0.2s;
		}
		.order-row:hover {
			background: #f0f0f0;
		}
		.status-pending { background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 4px; }
		.status-processing { background: #bfdbfe; color: #1e3a8a; padding: 4px 8px; border-radius: 4px; }
		.status-shipped { background: #a7f3d0; color: #065f46; padding: 4px 8px; border-radius: 4px; }
		.status-delivered { background: #86efac; color: #166534; padding: 4px 8px; border-radius: 4px; }
		.status-confirmed { background: #6ee7b7; color: #065f46; padding: 4px 8px; border-radius: 4px; }
		
		.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.4);
			align-items: center;
			justify-content: center;
		}
		.modal.show {
			display: flex;
		}
		.modal-content {
			background: white;
			padding: 30px;
			border-radius: 12px;
			max-width: 600px;
			max-height: 90vh;
			overflow-y: auto;
			box-shadow: 0 10px 40px rgba(0,0,0,0.2);
		}
		.modal-header { font-size: 20px; font-weight: 600; margin-bottom: 20px; }
		.close-modal {
			float: right;
			font-size: 28px;
			cursor: pointer;
			color: #999;
		}
		.close-modal:hover { color: #000; }
	</style>
</head>
<body>
	<!-- Seller Portal Navbar -->
	<div class="header">
		<a href="/admin" class="logo">LegitLah</a>
		<nav class="nav-links">
			<a href="/seller" class="nav-link active">Manage Orders</a>
			<a href="/sellerorders" class="nav-link">View All Orders</a>
			<a href="#" onclick="logout()" class="nav-link">Logout</a>
		</nav>
	</div>
	
	<div class="shell">
		<h1>Seller Portal</h1>
		<p class="lead">Manage orders and update shipment status for buyer visibility.</p>

		<div class="card">
			<div style="margin-bottom: 16px;">
				<label>Seller Contract Address</label>
				<div class="mono" style="padding: 10px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px; word-break: break-all;"><%= sellerContractAddress %></div>
			</div>
		</div>

		<div class="card">
			<h2>Orders Submitted by Buyers</h2>
			<div id="statusMessage"></div>
			<div id="ordersContainer" style="margin-top: 20px;">
				<p>Loading orders...</p>
			</div>
		</div>
	</div>

	<!-- Order Detail Modal -->
	<div id="orderModal" class="modal">
		<div class="modal-content">
			<span class="close-modal" onclick="closeModal()">&times;</span>
			<div class="modal-header">Order Details</div>
			<div class="row">
				<div>
					<label>Order ID</label>
					<div id="modalOrderId" style="padding: 10px; background: #f3f4f6; border-radius: 6px;">-</div>
				</div>
				<div>
					<label>Current Status</label>
					<div id="modalOrderStatus" style="padding: 10px; background: #f3f4f6; border-radius: 6px;">-</div>
				</div>
			</div>
			<div class="row" style="margin-top: 15px;">
				<div>
					<label>Product</label>
					<div id="modalProductName" style="padding: 10px; background: #f3f4f6; border-radius: 6px;">-</div>
				</div>
				<div>
					<label>Price (ETH)</label>
					<div id="modalProductPrice" style="padding: 10px; background: #f3f4f6; border-radius: 6px;">-</div>
				</div>
			</div>
			<div class="row" style="margin-top: 15px;">
				<div>
					<label>Buyer Name</label>
					<div id="modalBuyerName" style="padding: 10px; background: #f3f4f6; border-radius: 6px;">-</div>
				</div>
				<div>
					<label>Delivery Address</label>
					<div id="modalDeliveryAddress" style="padding: 10px; background: #f3f4f6; border-radius: 6px; word-break: break-word;">-</div>
				</div>
			</div>
			<div class="row" style="margin-top: 15px;">
				<div>
					<label>Buyer Address</label>
					<div id="modalBuyerAddress" class="mono" style="padding: 10px; background: #f3f4f6; border-radius: 6px; font-size: 12px; word-break: break-all;">-</div>
				</div>
				<div>
					<label>Paid?</label>
					<div id="modalPaidStatus" style="padding: 10px; background: #f3f4f6; border-radius: 6px;">-</div>
				</div>
			</div>
			<div style="margin-top: 15px;">
				<label>Tracking Number</label>
				<div id="modalTrackingNumber" class="mono" style="padding: 10px; background: #e0f2fe; border: 2px solid #0ea5e9; border-radius: 6px; font-weight: 600; color: #0369a1;">-</div>
			</div>
			<div style="margin-top: 20px;">
				<label>Update Status</label>
				<div style="display: flex; gap: 10px; flex-wrap: wrap;">
					<button class="ghost" onclick="updateOrderStatus(1)">Mark as Processing</button>
					<button class="ghost" onclick="updateOrderStatus(2)">Mark as Shipped</button>
					<button class="ghost" onclick="updateOrderStatus(3)">Mark as Delivered</button>
				</div>
			</div>
			<div id="modalMessage" style="margin-top: 15px;"></div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
	<script>
		let web3;
		let orderContract;
		let sellerContract;
		let userAccount;
		let selectedOrderId = null;
		
		const orderContractABI = <%- orderContractABI %>;
		const orderContractData = <%- orderContractData %>;
		const sellerContractABI = <%- sellerContractABI %>;
		const sellerContractData = <%- sellerContractData %>;

		const statusMap = {
			'0': 'Pending',
			'1': 'Processing',
			'2': 'Shipped',
			'3': 'Delivered',
			'4': 'Confirmed'
		};

		const statusClasses = {
			'0': 'status-pending',
			'1': 'status-processing',
			'2': 'status-shipped',
			'3': 'status-delivered',
			'4': 'status-confirmed'
		};

		async function init() {
			try {
				web3 = new Web3('http://127.0.0.1:7545');
				const accounts = await web3.eth.getAccounts();
				userAccount = accounts[0];

				// Initialize order contract
				const orderDeployedNetwork = orderContractData.networks[5777];
				if (!orderDeployedNetwork) {
					showMessage('Order contract not deployed on Ganache (5777).', 'error');
					return;
				}

				orderContract = new web3.eth.Contract(orderContractABI, orderDeployedNetwork.address);
				
				// Initialize seller contract
				const sellerDeployedNetwork = sellerContractData.networks[5777];
				if (sellerDeployedNetwork) {
					sellerContract = new web3.eth.Contract(sellerContractABI, sellerDeployedNetwork.address);
				}

				await loadAllOrders();
			} catch (err) {
				console.error(err);
				showMessage('Failed to initialize Web3: ' + err.message, 'error');
			}
		}

		async function loadAllOrders() {
			try {
				const orderContainer = document.getElementById('ordersContainer');
				orderContainer.innerHTML = '<p>Loading orders...</p>';

				// Get total order count
				const orderCount = await orderContract.methods.getOrderCount().call();
				
				if (orderCount == 0) {
					orderContainer.innerHTML = '<p style="color: #666;">No orders yet.</p>';
					return;
				}

				let tableHTML = `
					<table>
						<thead>
							<tr>
								<th>Order ID</th>
								<th>Buyer Address</th>
								<th>Product</th>
								<th>Price (ETH)</th>
								<th>Status</th>
								<th>Paid</th>
								<th>Action</th>
							</tr>
						</thead>
						<tbody>
				`;

				// Load all orders
				for (let i = 1; i <= orderCount; i++) {
					try {
						const order = await orderContract.methods.getOrder(i).call();
						const priceInETH = web3.utils.fromWei(order.totalAmount, 'ether');
						const statusClass = statusClasses[order.status] || 'status-pending';
						const statusText = statusMap[order.status] || 'Unknown';
						const paidStatus = order.isPaid ? 'Yes' : 'No';
						const fullBuyer = order.buyer;
						const shortBuyer = fullBuyer.substring(0, 10) + '...' + fullBuyer.substring(fullBuyer.length - 6);

						tableHTML += `
							<tr class="order-row" onclick="openOrderModal(${i})">
								<td><strong>#${i}</strong></td>
								<td>
									<div class="mono" style="font-size: 12px;">${fullBuyer}</div>
									<button class="ghost" style="margin-top:4px; padding:6px 10px;" onclick="copyAddress('${fullBuyer}'); event.stopPropagation();">Copy</button>
								</td>
								<td>${order.productName}</td>
								<td>${priceInETH}</td>
								<td><span class="${statusClass}">${statusText}</span></td>
								<td>${paidStatus}</td>
								<td><button class="primary" onclick="openOrderModal(${i}); event.stopPropagation();">Manage</button></td>
							</tr>
						`;
					} catch (err) {
						console.error(`Error loading order ${i}:`, err);
					}
				}

				tableHTML += `
						</tbody>
					</table>
				`;

				orderContainer.innerHTML = tableHTML;
			} catch (err) {
				console.error(err);
				showMessage('Failed to load orders: ' + err.message, 'error');
			}
		}

		async function openOrderModal(orderId) {
			try {
				selectedOrderId = orderId;
				const order = await orderContract.methods.getOrder(orderId).call();
				const priceInETH = web3.utils.fromWei(order.totalAmount, 'ether');
				const statusClass = statusClasses[order.status] || 'status-pending';
				const statusText = statusMap[order.status] || 'Unknown';
				const paidStatus = order.isPaid ? 'Yes' : 'No';

				document.getElementById('modalOrderId').textContent = '#' + orderId;
				document.getElementById('modalOrderStatus').innerHTML = `<span class="${statusClass}">${statusText}</span>`;
				document.getElementById('modalProductName').textContent = order.productName;
				document.getElementById('modalProductPrice').textContent = priceInETH + ' ETH';
				document.getElementById('modalBuyerName').textContent = order.buyerName || '-';
				document.getElementById('modalDeliveryAddress').textContent = order.deliveryAddress || '-';
				document.getElementById('modalBuyerAddress').textContent = order.buyer;
				
				const paidStatusEl = document.getElementById('modalPaidStatus');
				if (order.isPaid) {
					paidStatusEl.textContent = '✓ Yes - Paid';
					paidStatusEl.style.background = '#d1fae5';
					paidStatusEl.style.color = '#065f46';
					paidStatusEl.style.fontWeight = '600';
				} else {
					paidStatusEl.textContent = '✗ No - Unpaid';
					paidStatusEl.style.background = '#fee2e2';
					paidStatusEl.style.color = '#991b1b';
					paidStatusEl.style.fontWeight = '600';
				}
				
				// Load tracking number
				const trackingEl = document.getElementById('modalTrackingNumber');
				try {
					const trackingNumber = await orderContract.methods.getTrackingNumber(orderId).call({ from: userAccount });
					if (trackingNumber && trackingNumber.trim() !== '') {
						trackingEl.textContent = trackingNumber;
						trackingEl.style.background = '#e0f2fe';
						trackingEl.style.border = '2px solid #0ea5e9';
						trackingEl.style.color = '#0369a1';
					} else {
						trackingEl.textContent = 'Not shipped yet';
						trackingEl.style.background = '#f3f4f6';
						trackingEl.style.border = '1px solid #d1d5db';
						trackingEl.style.color = '#999';
					}
				} catch (trackingError) {
					console.warn('Could not load tracking number:', trackingError.message);
					trackingEl.textContent = 'Not available';
					trackingEl.style.background = '#f3f4f6';
					trackingEl.style.border = '1px solid #d1d5db';
					trackingEl.style.color = '#999';
				}
				
				document.getElementById('modalMessage').innerHTML = '';

				document.getElementById('orderModal').classList.add('show');
			} catch (err) {
				console.error(err);
				alert('Failed to load order details: ' + err.message);
			}
		}

		function closeModal() {
			document.getElementById('orderModal').classList.remove('show');
			selectedOrderId = null;
		}

		async function updateOrderStatus(statusCode) {
			try {
				if (!selectedOrderId) {
					showModalMessage('No order selected.', 'error');
					return;
				}

				if (!orderContract || !userAccount) {
					showModalMessage('Web3 not ready. Refresh the page.', 'error');
					return;
				}

				const statusText = statusMap[statusCode] || 'Unknown';
				let description = `Seller updated status to ${statusText}`;
				let trackingNumber = '';

				// If marking as Shipped (status 2), generate random tracking number
				if (statusCode === 2) {
					// Generate random tracking number (e.g., TRACK-XXXXXXXXXX)
					const randomPart = Math.random().toString(36).substring(2, 12).toUpperCase();
					const timestamp = Date.now().toString().slice(-6);
					trackingNumber = `TRACK-${randomPart}${timestamp}`;
					
					description = `Order shipped with tracking number: ${trackingNumber}`;

					// Use the new function that accepts tracking number
					const tx = await orderContract.methods.updateOrderStatusWithTracking(selectedOrderId, statusCode, description, trackingNumber)
						.send({ from: userAccount, gas: 500000 });

					showModalMessage(`Status updated to ${statusText}! Tracking: ${trackingNumber}`, 'success');
				} else {
					// Use regular updateOrderStatus for other statuses
					const tx = await orderContract.methods.updateOrderStatus(selectedOrderId, statusCode, description)
						.send({ from: userAccount, gas: 500000 });

					showModalMessage(`Status updated to ${statusText}!`, 'success');
				}
				
				// Reload the modal after 1 second
				setTimeout(async () => {
					await openOrderModal(selectedOrderId);
					await loadAllOrders();
				}, 1000);
			} catch (err) {
				console.error(err);
				showModalMessage('Failed to update status: ' + err.message, 'error');
			}
		}

		function showMessage(message, type) {
			const box = document.getElementById('statusMessage');
			box.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
		}

		function showModalMessage(message, type) {
			const box = document.getElementById('modalMessage');
			box.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
		}

		function copyAddress(addr) {
			navigator.clipboard.writeText(addr).catch(err => console.error('Copy failed:', err));
		}

		function logout() {
			fetch('/logout', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				}
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					window.location.href = '/';
				}
			})
			.catch(error => console.error('Error:', error));
		}

		// Close modal when clicking outside
		window.onclick = function(event) {
			const modal = document.getElementById('orderModal');
			if (event.target == modal) {
				closeModal();
			}
		}

		window.addEventListener('load', init);
	</script>
</body>
</html>
